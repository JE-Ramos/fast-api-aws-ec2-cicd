name: Shared Setup

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    outputs:
      environment:
        description: "The deployment environment"
        value: ${{ jobs.setup.outputs.environment }}
      aws-region:
        description: "AWS region for deployment"
        value: ${{ jobs.setup.outputs.aws-region }}

jobs:
  setup:
    name: Common Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      aws-region: ${{ steps.env.outputs.aws-region }}
    
    steps:
    - name: Determine Environment
      id: env
      run: |
        if [ "${{ inputs.environment }}" != "" ]; then
          ENVIRONMENT="${{ inputs.environment }}"
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          # Main branch deploys to production-green (live production)
          ENVIRONMENT="production-green"
        elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
          # Release branches deploy to production-blue (pre-production testing)
          ENVIRONMENT="production-blue"
        else
          # Develop and other branches deploy to staging
          ENVIRONMENT="staging"
        fi
        
        AWS_REGION="${{ secrets.AWS_REGION || 'us-east-1' }}"
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "aws-region=$AWS_REGION" >> $GITHUB_OUTPUT
        echo "🎯 Target Environment: $ENVIRONMENT"
        echo "🌍 AWS Region: $AWS_REGION"
        
        # Log deployment flow for clarity
        if [[ "$ENVIRONMENT" == "staging" ]]; then
          echo "📍 Deploying to STAGING (develop branch)"
        elif [[ "$ENVIRONMENT" == "production-blue" ]]; then
          echo "🔵 Deploying to PRODUCTION-BLUE (release testing)"
        elif [[ "$ENVIRONMENT" == "production-green" ]]; then
          echo "🟢 Deploying to PRODUCTION-GREEN (live production)"
        fi